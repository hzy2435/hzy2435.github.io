<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>SpringBoot 事务管理</title>
      <link href="/2021/02/28/SpringBoot-transaction/"/>
      <url>/2021/02/28/SpringBoot-transaction/</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-中事务抽象的核心接口"><a href="#Spring-中事务抽象的核心接口" class="headerlink" title="Spring 中事务抽象的核心接口"></a>Spring 中事务抽象的核心接口</h2><h3 id="PlatformTransactionManager"><a href="#PlatformTransactionManager" class="headerlink" title="PlatformTransactionManager"></a>PlatformTransactionManager</h3><p><code>PlatformTransactionManager</code> 接口是 Spring 提供的平台事务管理器，用于管理事务。该接口中提供了三个事务操作方法，具体如下：</p><ul><li><code>TransactionStatus getTransaction(TransactionDefinition definition)</code>：用于获取事务状态信息。</li><li><code>void commit(TransactionStatus status)</code>：用于提交事务。</li><li><code>void rollback(TransactionStatus status)</code>：用于回滚事务。</li></ul><h4 id="TransactionDefinition"><a href="#TransactionDefinition" class="headerlink" title="TransactionDefinition"></a>TransactionDefinition</h4><p><code>TransactionDefinition</code> 接口是事务定义（描述）的对象，它提供了事务相关信息获取的方法，其中包括4个操作，具体如下：</p><ul><li><code>int getIsolationLevel()</code>：获取事务的隔离级别。</li><li><code>int getPropagationBehavior()</code>：获取事务的传播行为。</li><li><code>int getTimeout()</code>：获取事务的超时时间。</li><li><code>boolean isReadOnly()</code>：获取事务是否只读。</li></ul><p>其中，事务的传播行为主要包括以下7种：</p><table><thead><tr><th>传播性</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>PROPAGATION_REQUIRED</td><td>0</td><td>当前有事务就用当前的，没有就用新的</td></tr><tr><td>PROPAGATION_SUPPORTS</td><td>1</td><td>事务可有可无，不是必须的</td></tr><tr><td>PROPAGATION_MANDATORY</td><td>2</td><td>当前事务一定要有事务，不然就抛异常</td></tr><tr><td>PROPAGATION_REQUIRES_NEW</td><td>3</td><td>无论是否有事务，都起个新的事务</td></tr><tr><td>PROPAGATION_NOT_SUPPORTED</td><td>4</td><td>不支持事务，按非事务方式运行</td></tr><tr><td>PROPAGATION_NEVER</td><td>5</td><td>不支持事务，如果有事务则抛异常</td></tr><tr><td>PROPAGATION_NESTED</td><td>6</td><td>当前有事务就在当前事务里再起一个事务</td></tr></tbody></table><h2 id="Spring-实现事务的两种方式"><a href="#Spring-实现事务的两种方式" class="headerlink" title="Spring 实现事务的两种方式"></a>Spring 实现事务的两种方式</h2><h3 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h3><p>Spring 允许以编程的方式实现事务管理，这是一种侵入式的事务管理方法。</p><p>Spring 推荐使用 TransactionTemplate 来管理事务，可以通过以下两个方法实现事务的回滚：</p><ul><li>TransactionCallback: 针对有返回值的事务回滚操作；</li><li>TransactionCallbackWithoutResult: 针对没有返回值的事务回滚操作。</li></ul><p>例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProgramTransactionApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> TransactionTemplate transactionTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(ProgramTransactionApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    log.info(<span class="string">"Transaction begin: &#123;&#125;"</span>, getCount());</span><br><span class="line">    <span class="comment">// 没有返回值的事务回滚操作</span></span><br><span class="line">    transactionTemplate.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doInTransactionWithoutResult</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">        jdbcTemplate.update(<span class="string">"INSERT INTO FOO(NAME) VALUES('TTT')"</span>);</span><br><span class="line">        log.info(<span class="string">"Transaction in: &#123;&#125;"</span>, getCount());</span><br><span class="line">        status.setRollbackOnly();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">"Transaction end: &#123;&#125;"</span>, getCount());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Long <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(<span class="string">"SELECT COUNT(*) FROM FOO"</span>, Long<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h3><p>声明式事务是基于注解的配置方式，其本质是利用 Spring 的 AOP，在方法执行前后进行拦截，然后生成对应类的代理类，通过调用代理类的方法实现事务的管理。</p><p>首先，需要先开启事务注解的方式：@EnableTransactionManager。</p><p>然后，使用 @Transactional 注解，标注在指定的方法上，实现事务的管理。例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span>(mode = AdviceMode.PROXY)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeclarativeTransactionApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">public</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> FooService fooService;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(DeclarativeTransactionApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    fooService.insertData();</span><br><span class="line">    log.info(<span class="string">"HHH: &#123;&#125;"</span>, jdbcTemplate</span><br><span class="line">        .queryForObject(<span class="string">"SELECT COUNT(*) FROM FOO WHERE NAME='HHH'"</span>, Long<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">      </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FooService 接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">insertData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FooService 接口实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooServiceImpl</span> <span class="keyword">implements</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    jdbcTemplate.execute(<span class="string">"INSERT INTO FOO (NAME) VALUES ('HHH')"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是事务生效的情况：</p><ol><li>基于接口的形式实现的 @Transactional 方法的访问级别必须是 public，且重写于父类接口；</li><li>调用 @Transactional 方法时，只有通过 对象.方法（比如：<code>fooService.insertData()</code>）的方式，事务才能生效。其中对象是被 AOP 增强过的类对象，主要是因为需要通过代理类来访问的方法才能实现事务管理的增强特性。</li></ol>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 多数据源配置</title>
      <link href="/2021/02/28/SpringBoot-multi-datasource/"/>
      <url>/2021/02/28/SpringBoot-multi-datasource/</url>
      
        <content type="html"><![CDATA[<h2 id="SpringBoot-的数据源做了哪些配置"><a href="#SpringBoot-的数据源做了哪些配置" class="headerlink" title="SpringBoot 的数据源做了哪些配置"></a>SpringBoot 的数据源做了哪些配置</h2><p>默认情况下，SpringBoot 会为项目自动化配置数据源相关属性。SpringBoot 主要通过以下自动配置类实现自动化配置：</p><ul><li><code>DataSourceAutoConfiguration</code>: 配置 DataSource；</li><li><code>DataSourceTransactionManagerAutoConfiguration</code>: 配置 DataSourceTransactionManager；</li><li><code>JdbcTemplateAutoConfiguration</code>: 配置 JdbcTemplate。</li></ul><p>当需要配置多数据源时，需要排除 SpringBoot 的自动配置：</p><ul><li>DataSourceAutoConfiguration</li><li>DataSourceTransactionManagerAutoConfiguration</li><li>JbdcTemplateAutoConfiguration</li></ul><p>然后，自定义实现多个数据源，不同数据源的配置要分开，并且关注每次使用的数据源。</p><h2 id="Spring-Boot中的多数据源配置"><a href="#Spring-Boot中的多数据源配置" class="headerlink" title="Spring Boot中的多数据源配置"></a>Spring Boot中的多数据源配置</h2><p>首先，需要在 <code>@SpringBootApplication</code> 注解上先排除 SpringBoot 的自动配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = &#123;DataSourceAutoConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">DataSourceTransactionManagerAutoConfiguration</span>.<span class="title">class</span>, <span class="title">JdbcTemplateAutoConfiguration</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Slf4j</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MultiDatasourceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(MultiDatasourceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着，在 <code>application.yml</code> 中配置多个数据源的属性：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置foo数据源</span></span><br><span class="line"><span class="attr">foo:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:foo</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span> </span><br><span class="line"><span class="comment"># 配置bar数据源</span></span><br><span class="line"><span class="attr">bar:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:bar</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span></span><br></pre></td></tr></table></figure><p>然后，配置 <code>DataSource</code> 多个数据源的Bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = &#123;DataSourceAutoConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">DataSourceTransactionManagerAutoConfiguration</span>.<span class="title">class</span>, <span class="title">JdbcTemplateAutoConfiguration</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Slf4j</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MultiDatasourceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(MultiDatasourceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注入配置文件 foo 数据源相关属性</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"foo.datasource"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">fooDataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用 foo 数据源相关属性初始化 DataSource</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">fooDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DataSourceProperties dataSourceProperties = fooDataSourceProperties();</span><br><span class="line">    log.info(<span class="string">"foo datasource: &#123;&#125;"</span>, dataSourceProperties.getUrl());</span><br><span class="line">    <span class="keyword">return</span> dataSourceProperties.initializeDataSourceBuilder().build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用 foo 数据源 DataSource 初始化 TransactionManager，实现对 foo 数据源的事务管理</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">fooTxManager</span><span class="params">(DataSource fooDataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(fooDataSource);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注入配置文件 bar 数据源相关属性</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"bar.datasource"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">barDataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用 bar 数据源相关属性初始化 DataSource</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">barDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DataSourceProperties dataSourceProperties = barDataSourceProperties();</span><br><span class="line">    log.info(<span class="string">"bar datasource: &#123;&#125;"</span>, dataSourceProperties.getUrl());</span><br><span class="line">    <span class="keyword">return</span> dataSourceProperties.initializeDataSourceBuilder().build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用 bar 数据源 DataSource 初始化 TransactionManager，实现对 bar 数据源的事务管理</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">barTxManager</span><span class="params">(DataSource barDataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(barDataSource);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，已经完成对 SpringBoot 多数据源的相关配置。后续数据库相关操作，需要关注每次使用的数据源。</p>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nacos 使用总结</title>
      <link href="/2020/06/14/nacos-%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"/>
      <url>/2020/06/14/nacos-%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h2 id="Nacos-简介"><a href="#Nacos-简介" class="headerlink" title="Nacos 简介"></a>Nacos 简介</h2><p>引用<a href="">官网介绍</a>：</p><ul><li><code>Nacos</code> 致力于帮助您发现、配置和管理微服务。<code>Nacos</code> 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</li><li><code>Nacos</code> 帮助您更敏捷和容易地构建、交付和管理微服务平台。 <code>Nacos</code> 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。</li></ul><p>本文将介绍 <code>Nacos</code> 作为微服务注册中心的及配置中心的集群配置及使用。</p><h2 id="Nacos-配置服务下载"><a href="#Nacos-配置服务下载" class="headerlink" title="Nacos 配置服务下载"></a>Nacos 配置服务下载</h2><p>通过 <a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">Nacos 官网</a> 下载自己所属操作系统的 <code>Nacos</code> 服务版本：</p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/nacosDownload.png" alt=""></p><p>这里选择 <code>nacos-server-1.3.0.zip</code> 下载完成后，解压到指定目录，这里解压到 <code>D:</code> 盘。</p><h2 id="Nacos-数据库配置"><a href="#Nacos-数据库配置" class="headerlink" title="Nacos 数据库配置"></a>Nacos 数据库配置</h2><p>默认情况下，<code>Nacos</code> 使用的是内置数据库进行数据存储服务。为了方便日后数据管理，这里配置成本地的 <code>MySQL</code>。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不过需要注意的是，Nacos 默认引入的 MySQL 数据库驱动不支持 MySQL8 及以上版本。如果需要支持 MySQL8 以上版本，需要自己 <span class="keyword">clone</span> <span class="title">Nacos</span> 源码并对引入的依赖版本进行修改后重新编译打包，这里就不再演示。</span><br></pre></td></tr></table></figure><p>进入 <code>Nacos</code> 解压根目录，进入 <code>conf</code> 目录，可以看到如下内容：</p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/nacos_config.png" alt=""></p><p>其中的 <code>nacos-mysql.sql</code> 文件就是 <code>Nacos</code> 所需的所有表结构，将其导入数据库中初始化，数据库表如下所示：</p><p> <img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614102156.png" alt=""></p><p>接着修改 <code>application.properties</code> 配置中的数据库连接配置，如下所示：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### If user MySQL as datasource:</span></span><br><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Count of DB:</span></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Connect URL of DB:</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://192.168.43.38:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="meta">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">db.password</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure><p>至此，数据相关的配置已经修改完毕。</p><h2 id="启动-Nacos-服务"><a href="#启动-Nacos-服务" class="headerlink" title="启动 Nacos 服务"></a>启动 Nacos 服务</h2><p>进入 <code>Nacos</code> 解压后的根目录，进入<code>bin</code> ，可以看到如下内容：</p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/nacos_cmd.png" alt=""></p><p>Windows 下的运行 <code>.cmd</code> 结尾的文件，Linux 下的运行 <code>.sh</code> 结尾的文件，运行成功后，如下所示：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-06-14 10:30:07,335 INFO Nacos started successfully in alone mode.</span><br></pre></td></tr></table></figure><p><code>nacos</code> 服务默认的启动端口好为 8848，可以在浏览器中输入 <code>http://localhost:8848/nacos</code> 直接访问，默认用户名和密码都是 <code>nacos</code>，如下所示：</p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/nacos_chrome.png" alt=""></p><p><code>Nacos</code> 注册中心已经配置并启动成功。</p><h2 id="使用-Nacos-注册中心注册服务"><a href="#使用-Nacos-注册中心注册服务" class="headerlink" title="使用 Nacos 注册中心注册服务"></a>使用 Nacos 注册中心注册服务</h2><p>新建 <code>SpringBoot</code> 项目，引入相关依赖：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">'org.springframework.boot'</span> version <span class="string">'2.3.0.RELEASE'</span></span><br><span class="line">    id <span class="string">'io.spring.dependency-management'</span> version <span class="string">'1.0.9.RELEASE'</span></span><br><span class="line">    id <span class="string">'java'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">'len.springcloud'</span></span><br><span class="line">version = <span class="string">'0.0.1-SNAPSHOT'</span></span><br><span class="line">sourceCompatibility = <span class="string">'1.8'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    set(<span class="string">'springCloudVersion'</span>, <span class="string">"Hoxton.SR5"</span>)</span><br><span class="line">    set(<span class="string">'springCloudAlibabaVersion'</span>, <span class="string">"2.0.2.RELEASE"</span>)</span><br><span class="line">    set(<span class="string">'httpClientVersion'</span>, <span class="string">"4.5.12"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">'org.springframework.boot:spring-boot-starter-web'</span></span><br><span class="line">    <span class="comment">// Alibaba nacos dependencies</span></span><br><span class="line">    implementation <span class="string">'com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-discovery'</span></span><br><span class="line"></span><br><span class="line">    testImplementation(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>) &#123;</span><br><span class="line">        exclude <span class="string">group:</span> <span class="string">'org.junit.vintage'</span>, <span class="string">module:</span> <span class="string">'junit-vintage-engine'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencyManagement &#123;</span><br><span class="line">    imports &#123;</span><br><span class="line">        mavenBom <span class="string">"org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;"</span></span><br><span class="line">        mavenBom <span class="string">"com.alibaba.cloud:spring-cloud-alibaba-dependencies:$&#123;springCloudAlibabaVersion&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">    useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着，在 <code>application.yml</code> 配置文件中配置 <code>Nacos</code> 注册中心：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br></pre></td></tr></table></figure><p>启动项目，可以在 <code>Nacos</code> 注册中心看到已经注册的服务：</p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/nacos_chrome1.png" alt=""></p><h2 id="Nacos-集群配置"><a href="#Nacos-集群配置" class="headerlink" title="Nacos 集群配置"></a>Nacos 集群配置</h2><p>默认情况下，<code>Nacos</code> 服务是以单机的形式启动，但实际项目中，往往会配置成集群形式。</p><ol><li>进入 <code>nacos</code> 安装根目录，点击进入 <code>conf</code> 目录，找到 <code>cluster.conf</code> 文件，双击打开：</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614151512.png" alt=""></p><ol start="2"><li>在 <code>cluster.conf</code> 文件配置集群的节点信息：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#it is ip</span><br><span class="line">#example</span><br><span class="line">192.168.43.236:8848</span><br><span class="line">192.168.43.236:8849</span><br><span class="line">192.168.43.236:8850</span><br></pre></td></tr></table></figure><ol start="3"><li>回到 <code>nacos</code> 安装根目录，点击进入 <code>bin</code> 目录：</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/nacos_cmd.png" alt=""></p><ol start="4"><li>在 Windows 下，修改 <code>startup.cmd</code> 启动模式为 <code>cluster</code>(集群模式)，如下所示：</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614150030.png" alt=""></p><ol start="5"><li><p>还是在当前文件，添加启动命令行，指定运行时端口：</p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614150234.png" alt=""></p></li><li><p>基本的配置完成后，复制 3  个 <code>startup.cmd</code>，并分别重命名为 <code>startup-8848.cmd</code>、<code>startup-8849.cmd</code>、<code>startup-8850.cmd</code>，分别代表集群三个节点端口的配置文件：</p></li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614150553.png" alt=""></p><ol start="7"><li>分别运行这三个文件，启动成功后，可以看到集群模式已经配置完成：</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614150855.png" alt=""></p><h2 id="使用-Nacos-配置中心"><a href="#使用-Nacos-配置中心" class="headerlink" title="使用 Nacos 配置中心"></a>使用 Nacos 配置中心</h2><p><code>Nacos</code> 不仅可以作为注册中心，同时也可以作为配置中心，使用 <code>Nacos</code> 作为配置中心有以下好处：</p><ul><li>无需再引入第三平台或插件</li><li>可以通过线上的形式实时更新配置</li></ul><ol><li>在 <code>Nacos</code> 后台，创建一个通用的配置，名字叫 <code>common-config.yml</code> :</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614153122.png" alt=""></p><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614153635.png" alt=""></p><ol start="2"><li>这里是我本地创建的两个通用配置和一个指定服务可用的配置：</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614154019.png" alt=""></p><h2 id="service-gateway-引用-Nacos-配置"><a href="#service-gateway-引用-Nacos-配置" class="headerlink" title="service-gateway 引用 Nacos 配置"></a>service-gateway 引用 Nacos 配置</h2><ol><li>引入 <code>nacos-config</code> 依赖：</li></ol><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-config'</span></span><br></pre></td></tr></table></figure><ol start="2"><li>重命名 <code>application.yml</code> 为 <code>bootstrap.yml</code>，使其启动时优先加载配置中心中的配置：</li></ol><p><img src="https://raw.githubusercontent.com/hzy2435/figure-bed/master/blog/imgs/20200614154332.png" alt=""></p><ol start="3"><li><code>bootstrap.yml</code> 中添加 <code>Nacos</code> 配置中心中的配置：</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-gateway</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848,localhost:8849,localhost:8850</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848,localhost:8849,localhost:8850</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br><span class="line">        <span class="comment"># 通用配置引用</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">          <span class="attr">dataId:</span> <span class="string">common-config.yml</span></span><br><span class="line">          <span class="attr">refresh:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">          <span class="attr">dataId:</span> <span class="string">log-config.yml</span></span><br><span class="line">          <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><ol start="4"><li>为了达到实时刷新配置的目的，在需要接口启动自动刷新：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> len.springcloud.lenservicegateway.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by len on 2020-06-11 08:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">// 启动刷新配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;custom.pic.path&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String picPath;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;logging.level.root&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String logger;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/getConfig"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"文件存放路径："</span> + picPath + <span class="string">", logger: "</span> + logger;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
          <category> nacos </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微服务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql 根据条件连多表查询</title>
      <link href="/2020/06/13/mysql-%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E8%BF%9E%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/"/>
      <url>/2020/06/13/mysql-%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E8%BF%9E%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/</url>
      
        <content type="html"><![CDATA[<h2 id="场景介绍"><a href="#场景介绍" class="headerlink" title="场景介绍"></a>场景介绍</h2><p>​        在工作中，有这样一个场景：比如微信用户与某个商户做关联，由于存在有多个业务场景，所以每个业务都有自己独立的微信用户表，但商户信息表只有一份。为了将微信用户与商户做关联，且为多对多的关系，这时会在关联表中设计一个表示业务场景的标识。</p><h2 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h2><p>​       根据以上场景，大概会有以下表：</p><ul><li>微信用户表：<code>tb_wx_merchant</code>, <code>tb_wx_selfcheck</code></li><li>商户表：<code>tb_subject</code></li><li>关联表：<code>tb_wx_bind_subject</code></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_wx_bind_subject(</span><br><span class="line"><span class="keyword">oid</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    subject_id <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    wx_user_id <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    wx_type <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    create_date datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="keyword">oid</span>)</span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT = <span class="number">1</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8</span><br></pre></td></tr></table></figure><p>其中 <code>wx_type</code> 在这里表示相关的业务场景，比如：<code>MERCHANT</code>、<code>SELFCHECK</code></p><h2 id="根据字段内容连多表查询"><a href="#根据字段内容连多表查询" class="headerlink" title="根据字段内容连多表查询"></a>根据字段内容连多表查询</h2><p>查询所有微信用户的商户记录信息：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">a.oid,</span><br><span class="line">a.subject_id,</span><br><span class="line">a.wx_user_id,</span><br><span class="line">a.wx_type,</span><br><span class="line">a.create_date,</span><br><span class="line">b.subject_name,</span><br><span class="line">b.address,</span><br><span class="line">(</span><br><span class="line">        <span class="keyword">CASE</span> a.wx_type</span><br><span class="line"><span class="keyword">WHEN</span> <span class="string">'MERCHANT'</span> <span class="keyword">THEN</span> c.nick_name</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'SELFCHECK'</span> <span class="keyword">THEN</span> d.nick_name</span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    ) nick_name,</span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">CASE</span> a.wx_type</span><br><span class="line"><span class="keyword">WHEN</span> <span class="string">'MERCHANT'</span> <span class="keyword">THEN</span> c.mobile</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'SELFCHECK'</span> <span class="keyword">THEN</span> d.mobile</span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    ) mobile</span><br><span class="line"><span class="keyword">FROM</span> tb_wx_bind_subject a</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> patrol_subject b <span class="keyword">ON</span> a.subject_id = b.oid</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tb_wx_selfcheck c <span class="keyword">ON</span> a.wx_type = <span class="string">'SELFCHECK'</span> <span class="keyword">AND</span> a.wx_user_id = d.oid</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tb_wx_merchant d <span class="keyword">ON</span> a.wx_type = <span class="string">'MERCHANT'</span> <span class="keyword">AND</span> a.wx_user_id = e.oid</span><br></pre></td></tr></table></figure><p>如上所示，主要是利用了 <code>MySQL</code> 中 <code>case ... when ... then</code>  结构进行判断匹配返回，缺点就是如果需要返回多个值时，需要重复使用 <code>case ... when ... then</code>  结构。</p>]]></content>
      
      
      <categories>
          
          <category> 实操 </category>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 文件上传和下载简单实现</title>
      <link href="/2020/04/18/SpringBoot-File/"/>
      <url>/2020/04/18/SpringBoot-File/</url>
      
        <content type="html"><![CDATA[<p>​        在 Spring Boot 项目，往往有处理文件上传/下载功能的需要，比如图片的上传，附件的上传下载等功能需求。在某次实践过程中，打算将本次的文件上传下载留作记录，故整理本文以备后面项目参考。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>本次实践中，为了保存文件的原始文件名记录，同时为了防止文件夹中出现多个同名文件，所以需要一个表来存放原文件名和自定义文件名的关系。</p><h3 id="创建资源表"><a href="#创建资源表" class="headerlink" title="创建资源表"></a>创建资源表</h3><p>创建 sys_resource 表来映射文件名和自定义文件名的关联关系，同时记录创建者的信息及创建时间，sql 如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`sys_resource`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`sys_resource`</span>  (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户 id'</span>,</span><br><span class="line">  <span class="string">`origin_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'源id'</span>,</span><br><span class="line">  <span class="string">`origin_type`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'源类型(课程/问题/评论)'</span>,</span><br><span class="line">  <span class="string">`resource_type`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'资源类型(文件/图片/视频)'</span>,</span><br><span class="line">  <span class="string">`resource_old_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'资源原始文件名'</span>,</span><br><span class="line">  <span class="string">`resource_new_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'资源系统生成文件名'</span>,</span><br><span class="line">  <span class="string">`create_date`</span> datetime(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建日期'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">'资源表'</span> ROW_FORMAT = Dynamic;</span><br></pre></td></tr></table></figure><h3 id="创建相应的-Java-Bean"><a href="#创建相应的-Java-Bean" class="headerlink" title="创建相应的 Java Bean"></a>创建相应的 Java Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 资源表</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> len</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-02-19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span>(callSuper = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@ApiModel</span>(value=<span class="string">"SysResource对象"</span>, description=<span class="string">"资源表"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysResource</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"源id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long originId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"源类型(课程/问题/评论)"</span>)</span><br><span class="line">    <span class="keyword">private</span> String originType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"资源类型(文件/图片/视频)"</span>)</span><br><span class="line">    <span class="keyword">private</span> String resourceType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"资源系统生成文件名"</span>)</span><br><span class="line">    <span class="keyword">private</span> String resourceNewName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"资源原始文件名"</span>)</span><br><span class="line">    <span class="keyword">private</span> String resourceOldName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"创建日期"</span>)</span><br><span class="line">    <span class="meta">@JSONField</span>(format = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createDate;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="配置相应的文件存放路径"><a href="#配置相应的文件存放路径" class="headerlink" title="配置相应的文件存放路径"></a>配置相应的文件存放路径</h3><p>需要将上传的图片等资源保存到指定的路径下，为此，在 <code>application.yml</code> 配置文件的路径，我本地的路径如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">basePath:</span> <span class="string">D:/Graduration/resources/</span></span><br></pre></td></tr></table></figure><p>接着，在控制器中注入配置的环境变量，以我项目的为示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/resource/sys-resource"</span>)</span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"/resource/sys-resource"</span>, tags = <span class="string">"系统资源"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysResourceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;resources.basePath&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String baseDir;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里可能需要注意，在使用 <code>@Value</code> 注入属性时，所在的类需要是 <code>Spring</code> 容器中管理的 <code>Bean</code>，所以需要先将类交由 <code>Spring</code> 容器管理，这里通过添加 <code>@RestController</code> 注解实现。<code>@RestController</code> 注解主要是指明该类是一个控制器类，负责接收请求，同时 <code>Rest</code> 表示该接口的所有请求返回的数据都将直接返回给前端，而不再是跳转的页面。</p><p>至此，相关的环境已经准备完毕。</p><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/resource/sys-resource"</span>)</span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"/resource/sys-resource"</span>, tags = <span class="string">"系统资源"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysResourceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;resources.basePath&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String baseDir;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@PostMapping</span>(<span class="string">"/file/upload"</span>)</span><br><span class="line">  <span class="meta">@RequiresRoles</span>(<span class="string">"teacher"</span>)</span><br><span class="line">  <span class="meta">@ApiOperation</span>(value = <span class="string">"上传课程文件"</span>, notes = <span class="string">"文件"</span>, response = ResponseEntity<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">uploadFile</span>(<span class="title">MultipartFile</span> <span class="title">file</span>, <span class="title">Long</span> <span class="title">originId</span>, <span class="title">Integer</span> <span class="title">originType</span>) <span class="title">throws</span> <span class="title">BaseException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (originId == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(ResponseEntity.ResponseCode.ERROR.getCode(), <span class="string">"资源id不能为空"</span>);</span><br><span class="line">    <span class="keyword">if</span> (originType == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(ResponseEntity.ResponseCode.ERROR.getCode(), <span class="string">"资源类型不能为空"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建资源映射对象</span></span><br><span class="line">    SysResource sysResource = <span class="keyword">new</span> SysResource();</span><br><span class="line">    <span class="comment">// 获取登录用户的 id (PS: 这是因为我的项目使用了 Shiro)</span></span><br><span class="line">    sysResource.setUserId(((SysUser) SecurityUtils.getSubject().getPrincipal()).getId());</span><br><span class="line">    sysResource.setOriginId(originId);</span><br><span class="line">    <span class="comment">// 项目使用枚举来识别源类型：COMMENT(1, "评论"), QUESTION(2, "问题"), COURSE(3, "课程");</span></span><br><span class="line">    sysResource.setOriginType(EnumUtil.obj2Enum(SysResourceEnum.OriginType.class, "getCode", originType).toString());</span><br><span class="line">    <span class="comment">// 项目使用枚举来识别文件类型：PICTURE(1, "图片"), VIDEO(2, "视频"), File(3, "文件");</span></span><br><span class="line">    sysResource.setResourceType(SysResourceEnum.ResourceType.File.toString());</span><br><span class="line">    <span class="comment">// 保存文件原始文件名</span></span><br><span class="line">    sysResource.setResourceOldName(file.getOriginalFilename());</span><br><span class="line">    <span class="comment">// 调用函数保存文件，并将系统生成的文件名存放起来</span></span><br><span class="line">    sysResource.setResourceNewName(saveFile(filePath, file));</span><br><span class="line">    sysResource.setCreateDate(LocalDateTime.now());</span><br><span class="line">    <span class="comment">// 调用 Service 保存文件上传记录</span></span><br><span class="line">    <span class="keyword">if</span> (sysResourceService.save(sysResource)) <span class="keyword">return</span> ResponseUtil.success(sysResource, <span class="string">"上传成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.error(<span class="string">"上传失败"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 该方法负责保存文件到系统中并返回系统生成的文件名</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">saveFile</span><span class="params">(String baseFolder, MultipartFile file)</span> <span class="keyword">throws</span> BaseException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 1. 获取文件保存路径</span></span><br><span class="line">      <span class="comment">// 1.1 这里以日期为基准，将文件按日期存放在不同的文件夹下，方便以后的管理</span></span><br><span class="line">      String format = sdf.format(<span class="keyword">new</span> Date());</span><br><span class="line">      String realPath = StringUtils.join(baseFolder, format);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 2. 判断路径是否存在，不存在则先创建相应的文件夹</span></span><br><span class="line">      File folder = <span class="keyword">new</span> File(realPath);</span><br><span class="line">      <span class="keyword">if</span> (!folder.exists()) &#123;</span><br><span class="line">        folder.mkdirs();</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// 3. 为文件生成一个系统中可以唯一识别的文件名</span></span><br><span class="line">      <span class="comment">// 3.1 先获取文件类型的后缀名</span></span><br><span class="line">      String oldName = file.getOriginalFilename();</span><br><span class="line">      <span class="comment">// 3.2 生成文件名</span></span><br><span class="line">      String newName = UUID.randomUUID().toString() + <span class="string">"."</span> + StringUtils.substringAfterLast(oldName, <span class="string">"."</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 4. 保存文件到系统指定文件夹下</span></span><br><span class="line">      file.transferTo(<span class="keyword">new</span> File(folder, newName));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 5. 返回文件名</span></span><br><span class="line">      <span class="keyword">return</span> StringUtils.join(format, <span class="string">"/"</span>, newName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(ResponseEntity.ResponseCode.ERROR.getCode(), e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码中的注释其实已经讲得比较清楚了。</p><h2 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/resource/sys-resource"</span>)</span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"/resource/sys-resource"</span>, tags = <span class="string">"系统资源"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysResourceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;resources.basePath&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String baseDir;</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/file/download"</span>)</span><br><span class="line">  <span class="meta">@ApiOperation</span>(value = <span class="string">"下载文件"</span>, notes = <span class="string">"文件"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exportUserInfo</span><span class="params">(String fileName, HttpServletResponse response)</span> <span class="keyword">throws</span> BaseException </span>&#123;</span><br><span class="line">    <span class="comment">// 获取文件保存路径</span></span><br><span class="line">    String realPath = StringUtils.join(baseDir, fileName);</span><br><span class="line">    <span class="comment">// 判断文件是否存在，不存在则返回下载失败</span></span><br><span class="line">    File file = <span class="keyword">new</span> File(realPath);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists() || !file.isFile()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(ResponseEntity.ResponseCode.ERROR.getCode(), <span class="string">"文件不存在"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取文件内容，并返回文件供用户下载</span></span><br><span class="line">    <span class="keyword">try</span> (InputStream inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">         BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(inputStream)) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">      <span class="keyword">int</span> i = bis.read(buffer);</span><br><span class="line">      OutputStream outputStream = response.getOutputStream();</span><br><span class="line">      <span class="keyword">while</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">        outputStream.write(buffer, <span class="number">0</span>, i);</span><br><span class="line">        i = bis.read(buffer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BaseException(ResponseEntity.ResponseCode.ERROR.getCode(), e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>这里使用 <code>Postman</code> 对接口进行测试。首先，测试文件上传功能：</p><p><img src="hexo_post_1.png" alt="测试文件上传"></p><p>接着，测试文件下载功能：</p><p><img src="hexo_post_2.png" alt="测试文件下载"></p><p><strong>这里需要注意的是</strong>：发送请求的按钮需要选择 <code>Send and Download</code> 按钮才能下载成功。</p>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hibernate-validator 使用</title>
      <link href="/2020/04/05/hibernate-validator/"/>
      <url>/2020/04/05/hibernate-validator/</url>
      
        <content type="html"><![CDATA[<h2 id="hibernate-validator-是什么"><a href="#hibernate-validator-是什么" class="headerlink" title="hibernate-validator 是什么"></a>hibernate-validator 是什么</h2><p>hibernate-validator 提供了符合 JSR 303 规范中所有内置 constraint 的实现，为 JavaBean 验证定义了相应的元数据模型和 API。简单地理解，使用 hibernate-validator 可以在项目中优雅地实现参数校验，并重用校验规则。</p><h2 id="使用-hibernate-validator"><a href="#使用-hibernate-validator" class="headerlink" title="使用 hibernate-validator"></a>使用 hibernate-validator</h2><h3 id="环境要求："><a href="#环境要求：" class="headerlink" title="环境要求："></a>环境要求：</h3><ul><li>最新版本的 hibernate-validator 要求 JDK &gt;= 8</li></ul><h3 id="Maven-引入（非-Spring-Boot-项目）："><a href="#Maven-引入（非-Spring-Boot-项目）：" class="headerlink" title="Maven 引入（非 Spring Boot 项目）："></a>Maven 引入（非 Spring Boot 项目）：</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Spring-Boot-项目："><a href="#Spring-Boot-项目：" class="headerlink" title="Spring Boot 项目："></a>Spring Boot 项目：</h3><p>默认情况下，<code>spring-boot-starter-web</code> 中已包含 <code>hibernate-validator</code> 依赖，所以只需要引入 <code>spring-boot-starter-web</code>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="hibernate-validator-常用注解"><a href="#hibernate-validator-常用注解" class="headerlink" title="hibernate-validator 常用注解"></a>hibernate-validator 常用注解</h2><p>hibernate-validator 包含以下常用注解：</p><table><thead><tr><th>序号</th><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td><code>@NotNull</code></td><td>判断非 null，常用于判断装饰类/自定义类不为 null</td></tr><tr><td>2</td><td><code>@NotEmpty</code></td><td>判断非 null，并且长度大于1；常用于判断集合不能为空</td></tr><tr><td>3</td><td><code>@NotBlank</code></td><td>判断非 null，并且去除前后空格后长度大于1；常用于判断字符串不能为空</td></tr><tr><td>4</td><td><code>@Null</code></td><td>判断 null</td></tr><tr><td>5</td><td><code>@Length</code></td><td>限制字符串的长度，@Length(min=1, max=50) 限制字符串长度在 1~50 间</td></tr><tr><td>6</td><td><code>@Size</code></td><td>限制集合的大小，@Size(min=1) 限制集合至少包含一个元素</td></tr><tr><td>7</td><td><code>@Past</code></td><td>检验日期是否为过去的日期</td></tr><tr><td>8</td><td><code>@Future</code></td><td>校验日期是否为将来的日期</td></tr><tr><td>9</td><td><code>@Min</code></td><td>校验值是否大于等于给定的值</td></tr><tr><td>10</td><td><code>@Max</code></td><td>校验值是否小于等于给定的值</td></tr><tr><td>11</td><td><code>@Digits</code></td><td>限制值的整数位和小数位，@Digits(intege=2,fraction=4) 限制2位整数和4位小数</td></tr><tr><td>12</td><td><code>@DecimalMin</code></td><td>限制 Decimal 类型数据大于等于给定值</td></tr><tr><td>13</td><td><code>@DecimalMax</code></td><td>限制 Decimal 类型数据小于等于给定值</td></tr><tr><td>14</td><td><code>@AssertTrue</code></td><td>限制 boolean 类型的值为 true</td></tr><tr><td>15</td><td><code>@AssertFalse</code></td><td>限制 boolean 类型的值为 false</td></tr><tr><td>16</td><td><code>@Pattern</code></td><td>自定义正则表达式校验</td></tr><tr><td>17</td><td><code>@Valid</code></td><td>递归的对关联的对象进行校验</td></tr><tr><td></td><td><code>@ScriptAssert</code></td><td>自定义校验脚本校验，可用于二选一情况的校验</td></tr></tbody></table><h2 id="在SpringBoot中校验示例"><a href="#在SpringBoot中校验示例" class="headerlink" title="在SpringBoot中校验示例"></a>在SpringBoot中校验示例</h2><ol><li><p>对 SysUser Bean 进行校验：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> len</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-02-19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span>(callSuper = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@ApiModel</span>(value=<span class="string">"SysUser对象"</span>, description=<span class="string">"用户账号密码表"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysUser</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户账号"</span>, required = <span class="keyword">true</span>)</span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"账号不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(max = <span class="number">20</span>, message = <span class="string">"账号长度最多 20"</span>)</span><br><span class="line">    <span class="keyword">private</span> String account;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"账号密码"</span>, required = <span class="keyword">true</span>)</span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]&#123;8,16&#125;$"</span>, message = <span class="string">"密码必须含有数字和字母，且长度要在8-16位之间"</span>, groups = AddGroup<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">password</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"盐值"</span>)</span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"账号状态"</span>)</span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"账号状态不能为空"</span>, groups = UpdateGroup<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">state</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户角色"</span>)</span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"需要为用户分配至少一种角色"</span>)</span><br><span class="line">    <span class="meta">@Valid</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SysRole&gt; sysRoles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><ul><li><p>注：这里使用了分组校验，所有的校验都属于某个分组，默认情况下，没注明表示属于 <code>Default</code> 分组。这在某些情况下很有用，比如新增和更新时校验规则并不完全一样，这里新增时不需要校验用户状态，但更新是需要状态不为空。</p></li><li><p><code>AddGroup</code>，<code>UpdateGroup</code> 是自定义的接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddGroup</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UpdateGroup</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ol start="2"><li><p>在控制器中启动校验：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> len</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-02-19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CrossOrigin</span> <span class="comment">// 允许跨域</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user/sys-user"</span>)</span><br><span class="line"><span class="meta">@Api</span>(value = <span class="string">"/user/sys-user"</span>, tags = <span class="string">"用户控制器"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysUserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"添加新用户"</span>, notes = <span class="string">"用户"</span>, httpMethod = <span class="string">"POST"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">createUser</span><span class="params">(@Validated(&#123;AddGroup.class, Default.class&#125;)</span> @RequestBody SysUser sysUser) <span class="keyword">throws</span> BaseException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.success(userInfoService.createUser(sysUserInfoDTO));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在控制器中指明，需要校验的对象，使用 <code>@Validated</code> 注解，并指定校验分组，这里指定应用 <code>AddGroup</code> 和 <code>Default</code> 两个分组的校验规则。</p></li><li><p>当校验不通过时会产生校验异常，可以在异常拦截接口处统一处理所有的校验异常，并包装成自定义的返回类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异常控制器</span></span><br><span class="line"><span class="comment"> * Created by len on 2020-02-20 23:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * hibernate validator 数据绑定验证异常拦截</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.OK)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">bindExceptionHandle</span>(<span class="title">BindException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">    ObjectError error = e.getAllErrors().get(<span class="number">0</span>);</span><br><span class="line">    log.info(<span class="string">"数据验证异常：&#123;&#125;"</span>, error.getDefaultMessage());</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.error(error.getDefaultMessage(), ResponseEntity.ResponseCode.BAD_REQUEST);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * hibernate validator 数据绑定验证异常拦截</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.OK)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(MethodArgumentNotValidException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">methodArgumentNotValidExceptionHandler</span>(<span class="title">MethodArgumentNotValidException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">    ObjectError error = e.getBindingResult().getAllErrors().get(<span class="number">0</span>);</span><br><span class="line">    log.info(<span class="string">"数据验证异常：&#123;&#125;"</span>, error.getDefaultMessage());</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.error(error.getDefaultMessage(), ResponseEntity.ResponseCode.BAD_REQUEST);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * spring validator 方法参数验证异常拦截</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.OK)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(ConstraintViolationException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">constraintViolationExceptionHandler</span>(<span class="title">ConstraintViolationException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">    Set&lt;ConstraintViolation&lt;?&gt;&gt; violations = e.getConstraintViolations();</span><br><span class="line">    ConstraintViolation&lt;?&gt; violation = violations.iterator().next();</span><br><span class="line">    log.info(<span class="string">"数据验证异常：&#123;&#125;"</span>, violation.getMessage());</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.error(violation.getMessage(), ResponseEntity.ResponseCode.BAD_REQUEST);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自定义异常</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.OK)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(BaseException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">systemExceptionHandler</span>(<span class="title">BaseException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">    log.error(<span class="string">"The request occur errors.&#123;&#125;"</span>, e);</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.error(e.getErrMsg(), e.getErrCode());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.OK)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">ResponseEntity</span> <span class="title">defaultExceptionHandler</span>(<span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">    log.error(<span class="string">"The request occur errors.&#123;&#125;"</span>, e);</span><br><span class="line">    <span class="keyword">return</span> ResponseUtil.error(e.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，完成了对用户的校验。</p></li></ol><h2 id="自定义校验注解"><a href="#自定义校验注解" class="headerlink" title="自定义校验注解"></a>自定义校验注解</h2><p>有时候，hibernate-validator 提供的校验规则并不能满足我们，比如对枚举的校验。这是，我们可以自定义自己的校验注解。以校验枚举类型为例：</p><h4 id="创建校验注解类："><a href="#创建校验注解类：" class="headerlink" title="创建校验注解类："></a>创建校验注解类：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by len on 2020-02-29 10:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.CONSTRUCTOR, ElementType.ANNOTATION_TYPE, ElementType.PARAMETER, ElementType.TYPE_USE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Repeatable</span>(Enum.List<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Constraint</span>(<span class="title">validatedBy</span> </span>= &#123; EnumValidator<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">Enum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "Enum is out of scope"</span>;</span><br><span class="line"></span><br><span class="line">  Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * the enum's class-type</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> Class</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Class&lt;?&gt; clazz();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * the method's name, which used to validate the enum's value</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> method's name</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">String <span class="title">method</span><span class="params">()</span> <span class="keyword">default</span> "ordinal"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Documented</span></span><br><span class="line">  <span class="meta">@Target</span>(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR, ElementType.PARAMETER, ElementType.TYPE_USE&#125;)</span><br><span class="line">  <span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">  <span class="meta">@interface</span> List &#123;</span><br><span class="line">    Enum[] value();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里通过 <code>@Target</code> 指明注解可以应用的类型，比如 <code>ElementType.FIELD</code> 表示注解可以应用在字段上。<code>@Constraint</code> 指明校验器，这里为 <code>EnumValidator</code> 类，具体实现参考下文。</p><p><code>Enum</code> 类中的 <code>Class&lt;?&gt; clazz();</code> 由使用者提供枚举的 class 对象，<code>String method() default &quot;ordinal&quot;;</code> 指明枚举进行校验的方法名，默认根据枚举 <code>oridinal</code> 进行校验。</p><h4 id="实现-ConstraintValidator-接口，实现具体的校验规则："><a href="#实现-ConstraintValidator-接口，实现具体的校验规则：" class="headerlink" title="实现 ConstraintValidator 接口，实现具体的校验规则："></a>实现 ConstraintValidator 接口，实现具体的校验规则：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by len on 2020-02-29 10:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">Enum</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Enum annotation;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Enum constraintAnnotation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.annotation = constraintAnnotation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object[] objects = annotation.clazz().getEnumConstants();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Method method = annotation.clazz().getMethod(annotation.method());</span><br><span class="line">      <span class="keyword">for</span> (Object o : objects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value.equals(method.invoke(o))) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过实现 <code>ConstraintValidator</code> 中的 <code>isValid</code> 方法，返回 true 表示校验通过，false 表示校验失败，并触发校验异常。</p><h4 id="使用-Enum-校验枚举"><a href="#使用-Enum-校验枚举" class="headerlink" title="使用 @Enum 校验枚举"></a>使用 @Enum 校验枚举</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiModelProperty</span>(value = <span class="string">"性别码"</span>, required = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@NotNull</span>(message = <span class="string">"性别不能为空"</span>)</span><br><span class="line"><span class="meta">@Enum</span>(method = <span class="string">"getCode"</span>, clazz = SysUserEnum.Sex<span class="class">.<span class="keyword">class</span>, <span class="title">message</span> </span>= <span class="string">"性别状态码错误"</span>)</span><br><span class="line"><span class="meta">@ExcelIgnore</span></span><br><span class="line"><span class="keyword">private</span> Integer sexCode;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysUserEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Getter</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">enum</span> Sex &#123;</span><br><span class="line">    MALE(<span class="number">0</span>, <span class="string">"男"</span>), FEMALE(<span class="number">1</span>, <span class="string">"女"</span>), UNKNOWN(<span class="number">2</span>, <span class="string">"未知"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    Sex(<span class="keyword">int</span> code, String desc) &#123;</span><br><span class="line">      <span class="keyword">this</span>.code = code;</span><br><span class="line">      <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="特殊场景"><a href="#特殊场景" class="headerlink" title="特殊场景"></a>特殊场景</h2><p>在实际使用中，发现有一种业务场景需要对两个字段进行二选一校验，即只需要其中一个字段的值不为空的情况，这时候可以使用 <code>@ScriptAssert</code> 注解实现。比如，有一个场景，采购单有商品名和商品照片两个字段，这两个字段值不能同时为空，可以这样做：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ScriptAssert</span>(lang = <span class="string">"javascript"</span>, script = <span class="string">"(itemName != null &amp;&amp; itemName.trim() != '') OR (itemPicture != null &amp;&amp; itemPicture.trim() != '') "</span>, message = <span class="string">"商品名和商品照片不能同时为空"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradeOrderItem</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String itemName;</span><br><span class="line">    <span class="keyword">private</span> String itemPicture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> 校验 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
